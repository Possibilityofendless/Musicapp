# Video Download Feature

## Overview
The MusicApp now has complete download functionality for final music videos.

## Backend Endpoints

### 1. Stitch Video
**POST** `/api/projects/:id/stitch`

Triggers the final video stitching process by combining all completed scenes.

**Requirements:**
- At least one scene with a completed video version
- Scenes must have `selectedVersionId` set and `soraClipUrl` available

**Response:**
```json
{
  "success": true,
  "message": "Stitching started"
}
```

**What it does:**
1. Validates all scenes have completed videos
2. Creates a `stitch_final` job in the queue
3. Updates project status to "processing"
4. Worker stitches all scene videos into one final video
5. Creates `GeneratedVideo` record with `type: "final"`

---

### 2. Get Download URL
**GET** `/api/projects/:id/download`

Retrieves the final video download information.

**Response:**
```json
{
  "success": true,
  "video": {
    "id": "video_id",
    "url": "https://storage.example.com/final-video.mp4",
    "thumbnailUrl": "https://storage.example.com/thumbnail.jpg",
    "duration": 180.5,
    "version": 1,
    "createdAt": "2026-02-13T00:00:00.000Z"
  }
}
```

**Error responses:**
- `404`: No final video available yet
- `403`: User doesn't own this project

---

## Database Schema

### GeneratedVideo Model
```prisma
model GeneratedVideo {
  id        String   @id @default(cuid())
  projectId String
  type      String   // "final" | "intermediate" | "sora_raw" | "lip_synced"
  url       String   // Direct download URL
  thumbnailUrl String?
  duration  Float?
  version   Int @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

**Type values:**
- `final` - The complete stitched music video (what users download)
- `intermediate` - Scene-level videos before stitching
- `sora_raw` - Raw output from Sora API
- `lip_synced` - Videos after lip-sync post-processing

---

## Frontend Implementation

### Components Added

**1. Final Video Section** (in ProjectEditor)
- Displays when `project.videos` array has items with `type: "final"`
- Shows video thumbnail, duration, and version
- Provides download button
- Automatically updates when video becomes available

**2. Stitch Button**
- Appears when no final video exists
- Disabled until scenes are generated
- Triggers POST to `/api/projects/:id/stitch`

### Store Actions

```typescript
stitchVideo: async (projectId: string) => Promise<void>
```

Triggers video stitching and reloads project data.

### API Client Methods

```typescript
api.stitchVideo(projectId: string)
```

---

## Usage Flow

### For Users:

1. **Create Project** - Upload audio & lyrics
2. **Generate Scenes** - Click "Generate Video" button
3. **Wait for Completion** - Scenes are generated by Sora
4. **Stitch Video** - Click "Stitch Final Video" button
5. **Download** - Click "Download" button when ready

### For Developers:

```bash
# 1. Create project with scenes
curl -X POST http://localhost:3000/api/projects \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "My Video",
    "audioUrl": "https://example.com/song.mp3",
    "duration": 180,
    "lyrics": "...",
    "performanceDensity": 0.5
  }'

# 2. Generate scenes (automatic in background)

# 3. Stitch final video
curl -X POST http://localhost:3000/api/projects/PROJECT_ID/stitch \
  -H "Authorization: Bearer $TOKEN"

# 4. Get download URL
curl http://localhost:3000/api/projects/PROJECT_ID/download \
  -H "Authorization: Bearer $TOKEN"

# 5. Download the video
curl -o final-video.mp4 "VIDEO_URL"
```

---

## File Storage

Videos are stored based on the `STORAGE_PATH` environment variable:

```env
STORAGE_PATH=/tmp/musicapp_storage
```

Structure:
```
/tmp/musicapp_storage/
├── audio/              # Uploaded audio files
├── videos/             # Scene videos
│   ├── sora_raw/      # Raw Sora output
│   ├── lip_synced/    # Post-processed with lip-sync
│   └── intermediate/  # Scene-level finals
└── final/             # Stitched final videos
```

---

## Testing

### Test Stitch Endpoint
```bash
TOKEN="your-token"
PROJECT_ID="your-project-id"

# Trigger stitching
curl -X POST http://localhost:3000/api/projects/$PROJECT_ID/stitch \
  -H "Authorization: Bearer $TOKEN"

# Check download
curl http://localhost:3000/api/projects/$PROJECT_ID/download \
  -H "Authorization: Bearer $TOKEN"
```

### Frontend Testing
1. Open http://localhost:5173
2. Login and create a project
3. Generate scenes
4. Look for "Final Video" section at the top
5. Click "Stitch Final Video"
6. Wait for completion (check project status)
7. Click "Download" button

---

## Status Tracking

Project status values:
- `draft` - Initial state
- `processing` - Scenes or final video being generated
- `completed` - All done, ready to download
- `failed` - Error occurred

Check status:
```bash
curl http://localhost:3000/api/projects/$PROJECT_ID \
  -H "Authorization: Bearer $TOKEN" | jq .status
```

---

## Cost Tracking

Each `GeneratedVideo` record can be associated with cost data:
- Project tracks `estimatedCostUsd` and `actualCostUsd`
- Useful for Sora API billing
- View in project details

---

## Troubleshooting

**"No final video available"**
- Ensure scenes are generated first
- Check that scenes have `soraClipUrl` populated
- Verify stitching job completed successfully

**Video won't download**
- Check video URL is valid
- Verify storage path is accessible
- Check CORS settings for external URLs

**Stitching fails**
- Check FFmpeg is installed
- Verify all scene videos are accessible
- Check worker logs for errors

---

## Architecture

```
User Request
    ↓
Frontend (Download button)
    ↓
POST /api/projects/:id/stitch
    ↓
Create "stitch_final" job
    ↓
Bull Queue → Redis
    ↓
Worker picks up job
    ↓
FFmpeg stitches videos
    ↓
Create GeneratedVideo record
    ↓
Update project status: "completed"
    ↓
User sees download button
    ↓
GET /api/projects/:id/download
    ↓
Returns video URL
    ↓
Download starts
```
